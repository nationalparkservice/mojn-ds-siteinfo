---
output:
  word_document:
    reference_docx: styles.docx
  html_document:
    df_print: paged
params:
  site.code: LAKE_P_COR0023
  #To include all visit notes, set visit.date to ALL. To include only most recent visit, set to NA.
  visit.date: ALL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(desertsprings)
library(tidyverse)
library(pool)
library(dbplyr)
library(devtools)

# Set up database connection
#install_github("nationalparkservice/mojn-ds-rpackage", ref = "master")
conn <- OpenDatabaseConnection()
db <- GetRawData(conn)

#Get Spring info from database
spring.info <- db$Visit %>%
  filter(SiteCode == params$site.code)

sensorRet.info <- db$SensorRetrievalAttempts %>%
  filter(SiteCode == params$site.code)

sensorDep.info <-db$SensorsCurrentlyDeployed %>%
  filter(SiteCode == params$site.code)

waterQual.info <- db$VisitActivity %>%
  filter(SiteCode == params$site.code) 

channelChar.info <- db$DischargeFlowCondition %>%
  filter(SiteCode == params$site.code) 

# Split spring info into most recent visit-level info...
visit.info <- spring.info %>%
  filter(VisitDate == max(VisitDate))

waterQualVisit.info <- db$VisitActivity %>%
   filter(VisitDate == max(VisitDate)) 

channelCharVisit.info <- db$DischargeFlowCondition %>%
   filter(VisitDate == max(VisitDate)) 

# ...and photo-level info
photo_mostrecent <- db$Photo %>%
  filter(VisitDate == max(VisitDate), PhotoSOP == 'RPT')

photo.info <- photo_mostrecent %>%
  select(PhotoType, RenamedFilePath, UtmX_m, UtmY_m, Notes) %>%
  mutate(RenamedFilePath = sub("\\\\\\\\INPLAKE52V\\\\ORG", "M:", RenamedFilePath))

photo.types <- c('SOURCE', 'UPSTR', 'DNSTR', 'SENSOR')

photo.info %<>%
  mutate(PhotoType = factor(PhotoType, levels = photo.types)) %>%
  arrange(PhotoType)

show_section <- if_else(params$visit.date == 'ALL',TRUE, FALSE)
```


---
title: `r visit.info$SiteCode`
author: `r visit.info$SiteName`
date: Last visited `r visit.info$VisitDate` (WY `r visit.info$FieldSeason`)
---

**Spring type: ** `r visit.info$SpringType`

**Sample frame: ** `r visit.info$SampleFrame`

**Visit notes: ** `r visit.info$Notes`

# Current Deployments
```{r include = FALSE}
dep.section <- NULL
for(row in 1:nrow(sensorDep.info)) {
  dep <- sensorDep.info[row,]
  dep.serialnumber <- dep$SerialNumber
  dep.visitdate <- dep$VisitDate
  #dep.notes <- if_else(is.na(dep$Notes), "", paste0(": ", dep$Notes))
  dep.notes <- dep$Notes
  
  dep.section <- c(dep.section, knitr::knit_expand("deployment-info.rmd"), collapse = '\n')
}
```

`r paste(knitr::knit(text = dep.section), collapse = '\n')`

# Discharge Flow Condition
```{r include = FALSE}
dischargeFlow.section <- NULL
  for(row in 1:nrow(channelChar.info)) {
  dis <- channelChar.info[row,]
  dis.visitdate <- dis$VisitDate
  #dis.notes <- if_else(is.na(dis$Notes), "", paste0(": ", dis$Notes))
  dis.notes <- dis$Notes
  
  dischargeFlow.section <- c(dischargeFlow.section, knitr::knit_expand("dischargeFlow-info.rmd"), collapse = '\n')
}

```

`r if_else((show_section == TRUE),{paste(knitr::knit(text = dischargeFlow.section), collapse = '\n')}, channelCharVisit.info$Notes)`

# Channel Characteristics
```{r include = FALSE}
channelChar.section <- NULL
  for(row in 1:nrow(channelChar.info)) {
  channel <- channelChar.info[row,]
  channel.visitdate <- channel$VisitDate
  #channel.notes <- if_else(is.na(channel$SpringbrookNotes), "", paste0(": ", channel$SpringbrookNotes))
  channel.notes <- channel$SpringbrookNotes
  
  channelChar.section <- c(channelChar.section, knitr::knit_expand("channelChar-info.rmd"), collapse = '\n')
}

```

`r if_else((show_section == TRUE),{paste(knitr::knit(text = channelChar.section), collapse = '\n')}, channelCharVisit.info$SpringbrookNotes)`


# Water Quality
``` {r include = FALSE}
waterQual.section <- NULL
for(row in 1:nrow(waterQual.info)){
  water <-waterQual.info[row,]
  water.visitdate <- water$VisitDate
  #water.notes <- if_else(is.na(water$WaterQualityNotes), "", paste0(": ", water$WaterQualityNotes))
  water.notes <- water$WaterQualityNotes
  
  waterQual.section <- c(waterQual.section, knitr::knit_expand("waterQual-info.rmd"), collapse = '\n')
}
```

`r if_else((show_section == TRUE),{paste(knitr::knit(text = waterQual.section), collapse = '\n')}, waterQualVisit.info$WaterQualityNotes)`


# Other Visits Notes
```{r include = FALSE}
visitsother.section  <- NULL
for(row in 1:nrow(spring.info)){
  visits <- spring.info[row,]
  visits.date <- visits$VisitDate
  #visits.notes <- if_else(is.na(visits$Notes), "", paste0(": ", visits$Notes))
  visits.notes <- visits$Notes    
  
  visitsother.section <- c(visitsother.section, knitr::knit_expand("visitsother-info.rmd"), collapse = '\n')
    }
```

`r if(show_section == TRUE){paste(knitr::knit(text = visitsother.section), collapse = '\n')}`

# Photos
```{r include=FALSE}
 photo.section <- NULL
 for(row in 1:nrow(photo.info)) {
  photo <- photo.info[row,]
  photo.path <- photo$RenamedFilePath
  photo.type <- photo$PhotoType
  utm.x <- photo$UtmX_m   
  utm.y <- photo$UtmY_m
  photo.notes <- if_else(is.na(photo$Notes), "", paste0(": ", photo$Notes))

   photo.section <- c(photo.section, knitr::knit_expand("photo-info.rmd"), collapse = '\n')
 }
```

`r paste(knitr::knit(text = photo.section), collapse = '\n')`

